<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Portal - Darshan Lodge</title>
    <style>
        :root { 
            --gold: #d4af37; 
            --gold-glow: rgba(212, 175, 55, 0.4);
            --blue-btn: #007bff; /* Royal Blue Shade */
            --blue-glass: rgba(255, 255, 255, 0.08); 
            --dark: #000814; 
        }
        
        body { margin: 0; background: var(--dark); color: white; font-family: 'Poppins', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }

        .top-nav { height: 70px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-bottom: 1px solid rgba(212, 175, 55, 0.2); position: fixed; width: 100%; top: 0; z-index: 100; box-sizing: border-box; }
        .avatar-circle { width: 42px; height: 42px; background: linear-gradient(45deg, var(--gold), #f9e297); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: black; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px var(--gold-glow); transition: 0.3s; }

        .container { padding: 100px 20px 40px; max-width: 500px; margin: auto; flex: 1; width: 100%; box-sizing: border-box; }

        /* Lodge Branding */
        .lodge-brand { text-align: center; margin-bottom: 25px; }
        .lodge-brand h1 { font-size: 2.2rem; font-weight: 900; color: var(--gold); letter-spacing: 4px; margin: 0; text-shadow: 0 0 20px var(--gold-glow); }

        /* Classy Greeting */
        .greeting-section { margin-bottom: 30px; border-left: 3px solid var(--gold); padding-left: 15px; }
        .greeting-section p { margin: 0; font-size: 0.85rem; font-weight: 300; opacity: 0.7; font-style: italic; }
        .greeting-section h2 { margin: 5px 0 0; font-size: 1.7rem; font-weight: 700; color: var(--gold); text-transform: capitalize; }

        /* Due Card */
        .due-card { background: var(--blue-glass); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 25px; padding: 35px 20px; text-align: center; margin-bottom: 30px; backdrop-filter: blur(10px); }
        .due-card h1 { font-size: 3.5rem; margin: 10px 0; font-weight: 800; }
        .pill { background: rgba(212, 175, 55, 0.15); border: 1px solid var(--gold); color: var(--gold); padding: 5px 15px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin: 5px; }

        /* History Table */
        .history-card { background: var(--blue-glass); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 15px; text-align: left; font-size: 0.7rem; opacity: 0.5; color: var(--gold); border-bottom: 1px solid rgba(255,255,255,0.1); }
        td { padding: 18px 15px; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.03); }

        /* Blue Payment Button */
        .btn-pay-blue { width: 100%; padding: 16px; background: var(--blue-btn); border: none; border-radius: 15px; color: white; font-weight: 800; font-size: 1rem; cursor: pointer; transition: 0.3s; box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3); }
        .btn-pay-blue:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 123, 255, 0.4); }

        /* Modal Settings */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 200; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-box { background: #001226; border: 1px solid var(--gold); padding: 30px; border-radius: 25px; width: 100%; max-width: 400px; text-align: center; }

        footer { text-align: center; padding: 25px; font-size: 0.65rem; opacity: 0.4; letter-spacing: 1.5px; margin-top: auto; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <div class="top-nav">
        <span style="font-weight:bold; color:var(--gold); font-size:0.8rem; letter-spacing:1px;">TENANT PORTAL</span>
        <div class="avatar-circle" id="userAvatar" onclick="openProfile()">?</div>
    </div>

    <div class="container">
        <div class="lodge-brand">
            <h1>DARSHAN LODGE</h1>
        </div>

        <div class="greeting-section">
            <p>It is a distinct pleasure to have you staying with us,</p>
            <h2 id="userName">Hello! Resident</h2>
        </div>

        <div class="due-card">
            <span style="font-size:0.7rem; opacity:0.6; text-transform:uppercase;">Outstanding Balance</span>
            <h1 id="displayDue">₹ 0</h1>
            <div>
                <div class="pill" id="roomPill">Room: --</div>
                <div class="pill" id="bedPill">Bed: --</div>
            </div>
        </div>

        <h4 style="color:var(--gold); margin-bottom:15px; font-size:0.8rem; letter-spacing:1.5px; text-transform: uppercase;">Payment History</h4>
        <div class="history-card">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="ledgerBody"></tbody>
            </table>
        </div>

        <button class="btn-pay-blue" onclick="openPayment()">Settle Dues Securely</button>
    </div>

    <footer>
        ©️ 2026 ALL RIGHTS RESERVED TO DARSHAN LODGE<br>
        DESIGNED & MANAGED BY OWNER: PDJ
    </footer>

    <div id="profileModal" class="modal">
        <div class="modal-box">
            <div class="avatar-circle" style="width:60px; height:60px; font-size:1.5rem; margin: 0 auto 15px;" id="modalAvatar">?</div>
            <h2 id="mName" style="color:var(--gold); margin:0;">User Name</h2>
            <p id="mEmail" style="opacity:0.6; margin:5px 0 25px; font-size:0.85rem;">user@email.com</p>
            <div style="text-align:left; background:rgba(255,255,255,0.03); padding:15px; border-radius:15px; font-size:0.9rem;">
                <p><b>Phone:</b> <span id="mPhone">--</span></p>
                <p><b>Guardian:</b> <span id="mParent">--</span></p>
                <p><b>Accommodation:</b> Room <span id="mRoom">--</span></p>
            </div>
            <button class="btn-pay-blue" style="margin-top:20px; padding:12px;" onclick="closeProfile()">Close Profile</button>
            <p onclick="handleLogout()" style="color:#ff4d4d; font-size:0.75rem; margin-top:20px; cursor:pointer; font-weight:bold;">LOGOUT SESSION</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDcl5VCCHMuwVDbqObs4oIntjBbC9x0yU0",
            authDomain: "darshan-lodge-16d22.firebaseapp.com",
            projectId: "darshan-lodge-16d22",
            storageBucket: "darshan-lodge-16d22.firebasestorage.app",
            messagingSenderId: "834416173936",
            appId: "1:834416173936:web:c6e62b396e5072f3e7e5b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let tenantData = null;

        // Sync UI with Firebase Data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    tenantData = snap.data();
                    const initial = tenantData.name ? tenantData.name.charAt(0).toUpperCase() : "U";
                    
                    // Update Header and Profile Avatars
                    document.getElementById('userAvatar').innerText = initial;
                    document.getElementById('modalAvatar').innerText = initial;
                    
                    // FIXED: Using Template Literals for Greeting
                    document.getElementById('userName').innerText = `Hello! ${tenantData.name}`;
                    
                    document.getElementById('displayDue').innerText = `₹ ${tenantData.totalDue || 0}`;
                    document.getElementById('roomPill').innerText = `Room: ${tenantData.room || '--'}`;
                    document.getElementById('bedPill').innerText = `Bed: ${tenantData.bed || '--'}`;
                    
                    updateLedger(tenantData.totalDue);
                }
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        // Update Ledger Table Based on Dues
        function updateLedger(due) {
            const table = document.getElementById('ledgerBody');
            const date = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            const status = due > 0 ? `<span style="color:#ff4d4d; font-weight:700;">Pending</span>` : `<span style="color:#2ecc71; font-weight:700;">Cleared</span>`;
            table.innerHTML = `<tr><td>${date}</td><td>${status}</td><td style="font-weight:700;">₹ ${due}</td></tr>`;
        }

        // Open External UPI Payment App
        window.openPayment = () => {
            if (!tenantData) return;
            const due = tenantData.totalDue || 0;
            if (due <= 0) return alert("Everything is clear. No dues found!");
            
            const upiId = "priyadarshan07@airtel"; 
            window.location.href = `upi://pay?pa=${upiId}&pn=DarshanLodge&am=${due}&cu=INR`;
        };

        // Modal Controls
        window.openProfile = () => {
            if (!tenantData) return;
            document.getElementById('mName').innerText = tenantData.name;
            document.getElementById('mEmail').innerText = tenantData.email;
            document.getElementById('mPhone').innerText = tenantData.phone || 'N/A';
            document.getElementById('mParent').innerText = tenantData.parentPhone || 'N/A';
            document.getElementById('mRoom').innerText = tenantData.room || '--';
            document.getElementById('profileModal').style.display = 'flex';
        };

        window.closeProfile = () => { 
            document.getElementById('profileModal').style.display = 'none'; 
        };

        window.handleLogout = () => { 
            signOut(auth).then(() => { 
                window.location.href = 'index.html'; 
            }); 
        };
    </script>
</body>
</html>